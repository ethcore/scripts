# .gitlab-ci.yml
# paritytech/scripts
#

stages:
  - build
  - test
  - prod

variables:                         &default-vars
  # DOCKER_HOST:                     tcp://docker:2375
  DOCKER_HOST:                     tcp://localhost:2375
  DOCKER_DRIVER:                   overlay2
  IMAGE_TAG:                       latest
  REGISTRY_PATH:                   paritytech

default:
  cache:                           {}

.build:                            &docker_build
  stage:                           build
  image:                           docker:stable
  dependencies:                    []
  services:
    - docker:dind
  only:
    variables:
      - $IMAGE_NAME == $CI_JOB_NAME
  tags:
    - kubernetes-parity-build

# Push to Dockerhub
.push_to_docker_hub:               &push_to_docker_hub
  - export IMAGE_DATE_TAG="$CI_COMMIT_SHORT_SHA-$(date +%Y%m%d)"
  - docker build --no-cache
      --build-arg VCS_REF="$CI_COMMIT_SHA"
      --build-arg BUILD_DATE="$(date +%Y%m%d)"
      --build-arg REGISTRY_PATH=$REGISTRY_PATH
      --tag $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_DATE_TAG
      --tag $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
      --file dockerfiles/$IMAGE_NAME/Dockerfile dockerfiles
  - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
  - docker info
  - docker push $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_DATE_TAG
  - docker push $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
  - docker logout

.push_to_staging:                  &push_to_staging
  - docker build
        --build-arg VCS_REF="$CI_COMMIT_SHA"
        --build-arg BUILD_DATE="$(date +%Y%m%d)"
        --build-arg REGISTRY_PATH=$REGISTRY_PATH
        --tag $REGISTRY_PATH/$IMAGE_NAME:staging
        --file dockerfiles/$IMAGE_NAME/Dockerfile dockerfiles
  - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
  - docker info
  - docker push $REGISTRY_PATH/$IMAGE_NAME:staging
  - docker logout

#### stage:                        build

#Build and push to docker hub and CI registry
base-ci-linux:
  <<:                              *docker_build
  script:
    - *push_to_docker_hub

ci-linux:
  <<:                              *docker_build
  script:
    - *push_to_staging

ink-ci-linux:
  <<:                              *docker_build
  script:
    - *push_to_docker_hub

contracts-ci-linux:
  <<:                              *docker_build
  script:
    - *push_to_staging

awscli:
  <<:                              *docker_build
  script:
    - *push_to_docker_hub

tools:
  <<:                              *docker_build
  script:
    - *push_to_docker_hub

query-exporter:
  <<:                              *docker_build
  script:
    - *push_to_docker_hub

redis-exporter:
  <<:                              *docker_build
  script:
    - *push_to_docker_hub

# build k8s on top of node 12-alpine
chaostools:
  <<:                              *docker_build
  variables:
    <<:                            *default-vars
    # https://github.com/kubernetes/kubernetes/releases
    BUILD_KUBE_VERSION:            "1.18.2"
  script:
    - |
      cat <<-EOT
      |
      | # build of chaostools image
      |
      | KUBE_VERSION = $BUILD_KUBE_VERSION
      |
      EOT
    - docker build
      --build-arg VCS_REF="$CI_COMMIT_SHA"
      --build-arg BUILD_DATE="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
      --build-arg REGISTRY_PATH=$REGISTRY_PATH
      --build-arg KUBE_VERSION="$BUILD_KUBE_VERSION"
      --tag $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
      --file dockerfiles/$IMAGE_NAME/Dockerfile dockerfiles
    # Push to Dockerhub
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
    - docker info
    - docker push $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
    - docker logout

# special case as version tags are introduced
kubetools:
  <<:                              *docker_build
  variables:
    <<:                            *default-vars
    # https://github.com/kubernetes/kubernetes/releases
    BUILD_KUBE_VERSION:            "1.18.2"
    # https://github.com/kubernetes/helm/releases
    # will be overwritten by the global variable at
    # https://gitlab.parity.io/groups/parity/-/settings/ci_cd
    BUILD_HELM_VERSION:            "2.16.11"
  script:
    - |
      cat <<-EOT
      |
      | # build of kubetools image
      |
      | KUBE_VERSION = $BUILD_KUBE_VERSION
      | HELM_VERSION = $BUILD_HELM_VERSION
      |
      EOT
    - docker build
      --build-arg VCS_REF="$CI_COMMIT_SHA"
      --build-arg BUILD_DATE="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
      --build-arg REGISTRY_PATH=$REGISTRY_PATH
      --build-arg KUBE_VERSION="$BUILD_KUBE_VERSION"
      --build-arg HELM_VERSION="$BUILD_HELM_VERSION"
      --tag $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
      --tag $REGISTRY_PATH/$IMAGE_NAME:$BUILD_HELM_VERSION
      --file dockerfiles/$IMAGE_NAME/Dockerfile dockerfiles
    # Push to Dockerhub
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
    - docker info
    - docker push $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
    - docker push $REGISTRY_PATH/$IMAGE_NAME:$BUILD_HELM_VERSION
    - docker logout


terraform:
  <<:                              *docker_build
  variables:
    <<:                            *default-vars
    # https://releases.hashicorp.com/terraform/
    TERRAFORM_VERSION:             "0.13.4"
  script:
    - |
      cat <<-EOT
      |
      | # build of terraform image
      |
      | TERRAFORM_VERSION = $TERRAFORM_VERSION
      |
      EOT
    - docker build
      --build-arg VCS_REF="$CI_COMMIT_SHA"
      --build-arg BUILD_DATE="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
      --build-arg REGISTRY_PATH=$REGISTRY_PATH
      --build-arg TERRAFORM_VERSION="$TERRAFORM_VERSION"
      --tag $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
      --tag $REGISTRY_PATH/$IMAGE_NAME:$TERRAFORM_VERSION
      --file dockerfiles/$IMAGE_NAME/Dockerfile dockerfiles
    # Push to Dockerhub
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
    - docker info
    - docker push $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
    - docker push $REGISTRY_PATH/$IMAGE_NAME:$TERRAFORM_VERSION
    - docker logout

#### stage:                        test

# triggers on $IMAGE_NAME
# in order to be scanned, EVERY docker build HAS to have $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_TAG
container_scanning:
  # Template does not work, had to override its config from
  # https://gitlab.com/gitlab-org/gitlab/blob/master/lib/gitlab/ci/templates/Security/Container-Scanning.gitlab-ci.yml
  # these settings are from the template
  stage:                           test
  image:                           $SECURE_ANALYZERS_PREFIX/klar:$CS_MAJOR_VERSION
  services:
    - name:                        $CLAIR_DB_IMAGE
      alias:                       clair-vulnerabilities-db
  allow_failure:                   true
  dependencies:                    []
  script:
    - /analyzer run
  artifacts:
    reports:
      container_scanning:          gl-container-scanning-report.json
  variables:
    SECURE_ANALYZERS_PREFIX:       "registry.gitlab.com/gitlab-org/security-products/analyzers"
    CS_MAJOR_VERSION:              2
    CLAIR_DB_IMAGE_TAG:            "latest"
    CLAIR_DB_IMAGE:                "$SECURE_ANALYZERS_PREFIX/clair-vulnerabilities-db:$CLAIR_DB_IMAGE_TAG"
  # these are our overrides
    <<:                            *default-vars
    GIT_STRATEGY:                  fetch
    CI_APPLICATION_REPOSITORY:     $REGISTRY_PATH/$IMAGE_NAME
    CI_APPLICATION_TAG:            $IMAGE_TAG # OR $IMAGE_DATE_TAG
    DOCKERFILE_PATH:               dockerfiles/$IMAGE_NAME/Dockerfile
  only:
    variables:
      - $IMAGE_NAME
  tags:
    - kubernetes-parity-build

ci-linux-test:
  stage:                           test
  image:                           $REGISTRY_PATH/$IMAGE_NAME:staging
  interruptible:                   true
  dependencies:                    []
  only:
    variables:
      - $IMAGE_NAME == "ci-linux"
  variables:
    <<:                            *default-vars
    GIT_STRATEGY:                  none
    RUSTFLAGS:                     "-Cdebug-assertions=y"
    WASM_BUILD_NO_COLOR:           1
  before_script:
    - rustup show
    - cargo --version
    - sccache -s
  script:
    - git clone https://github.com/paritytech/substrate .
    # test-linux-stable:
    - time cargo test --workspace --locked --release --verbose --features runtime-benchmarks --manifest-path bin/node/cli/Cargo.toml
    # check-web-wasm:
    - time cargo build --target=wasm32-unknown-unknown -p sp-io
    - time cargo build --target=wasm32-unknown-unknown -p sp-runtime
    - time cargo build --target=wasm32-unknown-unknown -p sp-std
    - time cargo build --target=wasm32-unknown-unknown -p sc-consensus-aura
    - time cargo build --target=wasm32-unknown-unknown -p sc-consensus-babe
    - time cargo build --target=wasm32-unknown-unknown -p sp-consensus
    - time cargo build --target=wasm32-unknown-unknown -p sc-telemetry
    - time cargo +nightly build --manifest-path=bin/node/cli/Cargo.toml --no-default-features --features browser --target=wasm32-unknown-unknown -Z features=itarget
  tags:
    - linux-docker

contracts-ci-linux-test:
  stage:                           test
  needs:
    - job:                         contracts-ci-linux
      artifacts:                   false
  trigger:
    project:                       parity/cargo-contract
    branch:                        master
    strategy:                      depend

#### stage:                        prod

ci-linux-production:
  stage:                           prod
  image:                           docker:stable
  services:
    - docker:dind
  only:
    variables:
      - $IMAGE_NAME == "ci-linux"
  script:
    - export IMAGE_DATE_TAG="$CI_COMMIT_SHORT_SHA-$(date +%Y%m%d)"
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
    - docker info
    - docker pull $REGISTRY_PATH/$IMAGE_NAME:staging
    - docker tag $REGISTRY_PATH/$IMAGE_NAME:staging $REGISTRY_PATH/$IMAGE_NAME:production
    - docker tag $REGISTRY_PATH/$IMAGE_NAME:staging $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_DATE_TAG
    - docker tag $REGISTRY_PATH/$IMAGE_NAME:staging parity/rust-builder:latest
    - docker push $REGISTRY_PATH/$IMAGE_NAME:production
    - docker push $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_DATE_TAG
    - docker logout
  tags:
    - kubernetes-parity-build

contracts-ci-linux-production:
  stage:                           prod
  image:                           docker:stable
  services:
    - docker:dind
  needs:
    - job:                         contracts-ci-linux-test
      artifacts:                   false
  script:
    - export IMAGE_DATE_TAG="$CI_COMMIT_SHORT_SHA-$(date +%Y%m%d)"
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
    - docker info
    - docker pull $REGISTRY_PATH/$IMAGE_NAME:staging
    - docker tag $REGISTRY_PATH/$IMAGE_NAME:staging $REGISTRY_PATH/$IMAGE_NAME:production
    - docker tag $REGISTRY_PATH/$IMAGE_NAME:staging $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_DATE_TAG
    - docker tag $REGISTRY_PATH/$IMAGE_NAME:staging parity/rust-builder:latest
    - docker push $REGISTRY_PATH/$IMAGE_NAME:production
    - docker push $REGISTRY_PATH/$IMAGE_NAME:$IMAGE_DATE_TAG
    - docker logout
  tags:
    - kubernetes-parity-build
